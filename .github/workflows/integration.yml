name: Integration Tests

# Integration tests using real audio datasets (MUSDB18-HQ, ESC-50)
# These tests evaluate model quality on standardized benchmarks.

on:
  # Weekly scheduled run
  schedule:
    - cron: "0 3 * * 0"  # Sundays at 3am UTC

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      test_scope:
        description: "Test scope (quick or full)"
        required: true
        type: choice
        options:
          - quick
          - full
        default: quick
      datasets:
        description: "Datasets to test (comma-separated: musdb18,esc50)"
        required: false
        default: "musdb18,esc50"
      generate_fixtures:
        description: "Generate Swift fixtures"
        required: false
        type: boolean
        default: false

env:
  # Dataset paths (must be configured in runner environment or secrets)
  MUSDB18_ROOT: ${{ secrets.MUSDB18_ROOT || '/datasets/MUSDB18HQ' }}
  ESC50_ROOT: ${{ secrets.ESC50_ROOT || '/datasets/ESC-50' }}

jobs:
  # Job 1: Python MUSDB18 separation quality tests
  musdb18-separation:
    name: MUSDB18 Separation (${{ github.event.inputs.test_scope || 'quick' }})
    runs-on: macos-latest
    if: contains(github.event.inputs.datasets || 'musdb18,esc50', 'musdb18')
    timeout-minutes: 180  # 3 hours max for full evaluation

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-integration-${{ hashFiles('python/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache HuggingFace models
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-hf-htdemucs-${{ hashFiles('python/mlx_audio/models/demucs/**') }}
          restore-keys: |
            ${{ runner.os }}-hf-htdemucs-

      - name: Install dependencies
        run: |
          cd python
          pip install -e ".[dev,test]"
          pip install mir_eval soundfile

      - name: Check MUSDB18 availability
        id: check-musdb18
        run: |
          if [ -d "$MUSDB18_ROOT" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "MUSDB18-HQ found at $MUSDB18_ROOT"
            ls -la "$MUSDB18_ROOT" | head -10
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "::error::MUSDB18-HQ dataset not found at $MUSDB18_ROOT"
            echo "Integration tests require the MUSDB18-HQ dataset to be available."
            echo "Configure the MUSDB18_ROOT secret or ensure the dataset exists on the runner."
            exit 1
          fi

      - name: Run MUSDB18 quick tests
        if: github.event.inputs.test_scope != 'full'
        run: |
          cd python
          pytest tests/integration/test_musdb18_separation.py \
            -m "integration and not slow" \
            -v --tb=short \
            2>&1 | tee musdb18-results.txt

      - name: Run MUSDB18 full evaluation
        if: github.event.inputs.test_scope == 'full'
        run: |
          cd python
          pytest tests/integration/test_musdb18_separation.py \
            -m "integration" \
            -v --tb=short \
            2>&1 | tee musdb18-results.txt

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: musdb18-separation-results
          path: python/musdb18-results.txt
          retention-days: 30

  # Job 2: Python ESC-50 classification quality tests
  esc50-classification:
    name: ESC-50 Classification (${{ github.event.inputs.test_scope || 'quick' }})
    runs-on: macos-latest
    if: contains(github.event.inputs.datasets || 'musdb18,esc50', 'esc50')
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-integration-${{ hashFiles('python/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache HuggingFace models
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-hf-clap-${{ hashFiles('python/mlx_audio/models/clap/**') }}
          restore-keys: |
            ${{ runner.os }}-hf-clap-

      - name: Install dependencies
        run: |
          cd python
          pip install -e ".[dev,test]"
          pip install scipy soundfile

      - name: Check ESC-50 availability
        id: check-esc50
        run: |
          if [ -d "$ESC50_ROOT" ]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "ESC-50 found at $ESC50_ROOT"
            ls -la "$ESC50_ROOT" | head -10
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "::error::ESC-50 dataset not found at $ESC50_ROOT"
            echo "Integration tests require the ESC-50 dataset to be available."
            echo "Configure the ESC50_ROOT secret or ensure the dataset exists on the runner."
            exit 1
          fi

      - name: Run ESC-50 quick tests
        if: github.event.inputs.test_scope != 'full'
        run: |
          cd python
          pytest tests/integration/test_esc50_classification.py \
            -m "integration and not slow" \
            -v --tb=short \
            2>&1 | tee esc50-results.txt

      - name: Run ESC-50 full evaluation
        if: github.event.inputs.test_scope == 'full'
        run: |
          cd python
          pytest tests/integration/test_esc50_classification.py \
            -m "integration" \
            -v --tb=short \
            2>&1 | tee esc50-results.txt

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: esc50-classification-results
          path: python/esc50-results.txt
          retention-days: 30

  # Job 3: Generate Swift integration fixtures
  generate-fixtures:
    name: Generate Swift Fixtures
    runs-on: macos-latest
    if: github.event.inputs.generate_fixtures == 'true'
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-integration-${{ hashFiles('python/pyproject.toml') }}

      - name: Cache HuggingFace models
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-hf-all-${{ hashFiles('python/mlx_audio/models/**') }}

      - name: Install dependencies
        run: |
          cd python
          pip install -e ".[dev]"
          pip install safetensors soundfile

      - name: Generate MUSDB18 fixtures
        if: contains(github.event.inputs.datasets || 'musdb18', 'musdb18')
        run: |
          cd python
          python tests/integration/generate_musdb18_fixtures.py \
            --musdb18-root "$MUSDB18_ROOT" \
            --output-dir ../swift/Tests/Fixtures/Integration/musdb18 \
            --tracks 5 \
            --duration 30.0

      - name: Upload fixtures
        uses: actions/upload-artifact@v4
        with:
          name: integration-fixtures
          path: swift/Tests/Fixtures/Integration/
          retention-days: 7

  # Job 4: Swift integration tests (uses pre-generated fixtures)
  swift-integration:
    name: Swift Integration Tests
    runs-on: macos-latest
    needs: [generate-fixtures]
    if: always() && github.event.inputs.generate_fixtures == 'true'
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - name: Download fixtures
        uses: actions/download-artifact@v4
        with:
          name: integration-fixtures
          path: swift/Tests/Fixtures/Integration/

      - name: Cache HuggingFace models
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: ${{ runner.os }}-hf-swift-${{ hashFiles('swift/Sources/MLXAudioModels/**') }}

      - name: Build Swift package
        run: |
          cd swift
          swift build

      - name: Run Swift integration tests
        env:
          INTEGRATION_FIXTURES: ${{ github.workspace }}/swift/Tests/Fixtures/Integration/musdb18
          ESC50_FIXTURES: ${{ github.workspace }}/swift/Tests/Fixtures/Integration/esc50
        run: |
          cd swift
          swift test --filter IntegrationTests \
            2>&1 | tee integration-results.txt

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: swift-integration-results
          path: swift/integration-results.txt
          retention-days: 30

  # Job 5: Summary and quality report
  summary:
    name: Integration Summary
    runs-on: ubuntu-latest
    needs: [musdb18-separation, esc50-classification]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Generate summary
        run: |
          echo "## Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Scope:** ${{ github.event.inputs.test_scope || 'quick' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Datasets:** ${{ github.event.inputs.datasets || 'musdb18,esc50' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.musdb18-separation.result }}" == "success" ]; then
            echo "✅ **MUSDB18 Separation:** Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.musdb18-separation.result }}" == "skipped" ]; then
            echo "⏭️ **MUSDB18 Separation:** Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **MUSDB18 Separation:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.esc50-classification.result }}" == "success" ]; then
            echo "✅ **ESC-50 Classification:** Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.esc50-classification.result }}" == "skipped" ]; then
            echo "⏭️ **ESC-50 Classification:** Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **ESC-50 Classification:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quality Targets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Model | Metric | Target |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| HTDemucs | Mean SDR | >7.0 dB |" >> $GITHUB_STEP_SUMMARY
          echo "| HTDemucs (drums) | SDR | >8.5 dB |" >> $GITHUB_STEP_SUMMARY
          echo "| HTDemucs (vocals) | SDR | >8.0 dB |" >> $GITHUB_STEP_SUMMARY
          echo "| CLAP | Zero-shot Accuracy | >85% |" >> $GITHUB_STEP_SUMMARY

          # Check if any job failed
          if [ "${{ needs.musdb18-separation.result }}" == "failure" ] || \
             [ "${{ needs.esc50-classification.result }}" == "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ Some integration tests failed. Check individual job logs for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All integration tests completed successfully!" >> $GITHUB_STEP_SUMMARY
